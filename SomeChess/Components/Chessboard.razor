@inject IJSRuntime JsRuntime;
@using Microsoft.AspNetCore.Components.Web
@using SomeChess.Code.GameEngine.ChessImplementation
@using SomeChess.Code.MatchMaking.ChessMatchImplementation
@using SomeChess.Code.Social

@if (!Reload)
{
    <div class="flex text-center justify-center place-content-evenly mt-7">
        <div class="chessboard select-none flex text-center justify-center">
            @for (int i = 0; i < 8; i++)
            {
                int LoopI = i;
                <div>
                    @for (int u = 7; u >= 0; u--)
                    {
                        int LoopU = u;
                        string color = "";
                        if (LoopI % 2 == 0) // LoopI ist gerade
                        {
                            if (LoopU % 2 != 0) // LoopU ist ungerade
                                color = "blackCell";
                            else //LoopU ist gerade
                                color = "whiteCell";
                        }
                        else //LoopI ist ungerade
                        {
                            if (LoopU % 2 != 0) //LoopU ist ungerade
                                color = "whiteCell";
                            else // LoopU ist gerade
                                color = "blackCell";
                        }

                        string pieceColor;
                        @if (ChessGame.Board.GetPiece(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString()).Team == Team.White)
                            pieceColor = "w";
                        else pieceColor = "b";

                        <div class="item @color " onmouseup="getMouseUpElementID(event)" onmousedown="getMouseDownID(this)" onmouseover="SelectedPeace(this)" id="@(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString())">
                            @((MarkupString)PieceToHTML[ChessGame.Board.GetPiece(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString()).PieceType].Replace("src=\"images/w", $"src=\"images/{pieceColor}"))
                        </div>
                    }
                </div>
            }
        </div>
        <div class="backholder ml-24 flex flex-col text-center ">
            <h1 class="greengradient anton-regular">
                Play Chess<br />
                Online<br />
                on the #1 Site!
            </h1>
            <div>
                <button @onclick="() => { PlayOnline = true;}" class="playOnline"><img width="72" height="2" src="images/online-icon.png" />Play Online<br /><span>Play with a real person online!</span></button>
            </div>
            <div>
                <button class="playComputer"><img width="72" height="2" src="images/computer-icon.png" /> Computer<br /><span class="smalltextPlayComputer">Play vs training bots</span></button>
            </div>
        </div>
    </div>
}
else
{
    <div class="flex text-center justify-center place-content-evenly mt-7">
        <div class="chessboard select-none flex text-center justify-center">
            @for (int i = 0; i < 8; i++)
            {
                int LoopI = i;
                <div>
                    @for (int u = 7; u >= 0; u--)
                    {
                        int LoopU = u;
                        string color = "";
                        if (LoopI % 2 == 0) // LoopI ist gerade
                        {
                            if (LoopU % 2 != 0) // LoopU ist ungerade
                                color = "blackCell";
                            else //LoopU ist gerade
                                color = "whiteCell";
                        }
                        else //LoopI ist ungerade
                        {
                            if (LoopU % 2 != 0) //LoopU ist ungerade
                                color = "whiteCell";
                            else // LoopU ist gerade
                                color = "blackCell";
                        }

                        string pieceColor;
                        @if (ChessGame.Board.GetPiece(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString()).Team == Team.White)
                            pieceColor = "w";
                        else pieceColor = "b";

                        <div class="item @color " onmouseup="getMouseUpElementID(event)" onmousedown="getMouseDownID(this)" onmouseover="SelectedPeace(event)" id="@(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString())">
                            @((MarkupString)PieceToHTML[ChessGame.Board.GetPiece(Chess.AlphConversionChars[LoopI] + (LoopU + 1).ToString()).PieceType].Replace("src=\"images/w", $"src=\"images/{pieceColor}"))
                        </div>
                    }
                </div>
            }
        </div>
        <div class="backholder ml-24 flex flex-col text-center ">
            <h1 class="greengradient anton-regular">
                Play Chess<br />
                Online<br />
                on the #1 Site!
            </h1>
            <div>
                <button @onclick="() => { PlayOnline = true;}" class="playOnline"><img width="72" height="2" src="images/online-icon.png" />Play Online<br /><span>Play with a real person online!</span></button>
            </div>
            <div>
                <button class="playComputer"><img width="72" height="2" src="images/computer-icon.png" /> Computer<br /><span class="smalltextPlayComputer">Play vs training bots</span></button>
            </div>
        </div>
    </div>
}
@if (PlayOnline == true)
{
    <div class="chooseTime flex flex-col">
        <div>
            <span @onclick="() => { PlayOnline = false; }" class="material-symbols-outlined fixed absolute select-none">cancel</span>
            <h1 class="greengradient ml-16">Choose a Time</h1>
        </div>
        <div class="ml-8">
            <div>
                <h2 class="anton-regular mt-5">Bullet</h2>
                <div class="flex justify-evenly">
                    <button @onclick="() => {SetButtonState(1); CreateChessMatch(GameMode.OnlineOneMinute);}" class="@((SelectedButton == 1) ? "selectedTimeShadow" : "")">1 Minutes</button>
                    <button @onclick="() => {SetButtonState(2); CreateChessMatch(GameMode.OnlineOneMinutePlusOne);}" class="@((SelectedButton == 2) ? "selectedTimeShadow" : "")">1 | 1</button>
                    <button @onclick="() => {SetButtonState(3); CreateChessMatch(GameMode.OnlineTwoMinutesPlusOne);}" class="@((SelectedButton == 3) ? "selectedTimeShadow" : "")">2 | 1</button>
                </div>

            </div>
            <div>
                <h2 class="anton-regular  mt-7">Blitz</h2>
                <div class="flex justify-evenly">
                    <button @onclick="() => {SetButtonState(4); CreateChessMatch(GameMode.OnlineThreeMinutes);}" class="@((SelectedButton == 4) ? "selectedTimeShadow" : "")">3 Minutes</button>
                    <button @onclick="() => {SetButtonState(5); CreateChessMatch(GameMode.OnlineThreeMinutesPlusTwo);}" class="@((SelectedButton == 5) ? "selectedTimeShadow" : "")">3 | 2</button>
                    <button @onclick="() => {SetButtonState(6); CreateChessMatch(GameMode.OnlineFiveMinutes);}" class="@((SelectedButton == 6) ? "selectedTimeShadow" : "")">5 Minutes</button>
                </div>

            </div>
            <div>
                <h2 class="anton-regular mt-7">Rapid</h2>
                <div class="flex justify-evenly">
                    <button @onclick="() => {SetButtonState(7); CreateChessMatch(GameMode.OnlineTenMinutes);}" class="@((SelectedButton == 7) ? "selectedTimeShadow" : "")">10 Minutes</button>
                    <button @onclick="() => {SetButtonState(8); CreateChessMatch(GameMode.OnlineFifteenMinutesPlusTen);}" class="@((SelectedButton == 8) ? "selectedTimeShadow" : "")">15 | 10</button>
                    <button @onclick="() => {SetButtonState(9); CreateChessMatch(GameMode.OnlineThirtyMinutes); }" class="@((SelectedButton == 9) ? "selectedTimeShadow" : "")">30 Minutes</button>
                </div>
            </div>
            <div class="playButton flex justify-center mt-14 select-none">
                <a class="flex text-center justify-center">Play</a>
            </div>
        </div>
    </div>

@*     @if (GameOver)
    {
        <span @onclick="() => { NotNewGame = true; }" class="material-symbols-outlined fixed absolute select-none">cancel</span>
        <div class="bg-green-300 w-4/12 h-3/6 ml-32">
            @if(GameWon == "white")
            {
                <p class="anton-regular text-lg">You won the game!</p>
            }
            else
            {
                <p class="anton-regular text-lg ">You lost the game</p>
            }
            <button>PLay new one!</button>
        </div>
    } *@
}


@code {
    bool NotNewGame = false;
    public bool isDragging = true;
    public bool PlayOnline = false;
    public bool Reload = true;
    int SelectedButton = 0;
    public Chess ChessGame = new Chess();
    public ChessMatchConstructor constructor = new();

    public Dictionary<ChessPieceType, string> PieceToHTML = new Dictionary<ChessPieceType, string>()
    {
        { ChessPieceType.Pawn, "<div class=\"@((isDragging) ? \"selected\" : \"\")\" >\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"powns chessPiece\" src=\"images/w_pawn.png\" />\r\n</div>" },
        { ChessPieceType.Knight, "<div class=\"@((isDragging) ? \"selected\" : \"\")\" >\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"knight chessPiece\" src=\"images/w_knight.png\" />\r\n</div>"},
        { ChessPieceType.Bishop, "<div class=\"@((isDragging) ? \"selected\" : \"\")\" >\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"normalefiguren chessPiece chessPiece\" src=\"images/w_bishop.png\" />\r\n</div>"},
        { ChessPieceType.Rook, "<div class=\"@((isDragging) ? \"selected\" : \"\")\">\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"rook chessPiece\" src=\"images/w_rook.png\" />\r\n</div>" },
        { ChessPieceType.Queen, "<div class=\"@((isDragging) ? \"selected\" : \"\")\" >\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"normalefiguren chessPiece\" src=\"images/w_queen.png\" />\r\n </div>"},
        { ChessPieceType.King, "<div class=\"@((isDragging) ? \"selected\" : \"\")\" >\r\n <img draggable=\"true\" ondragstart=\"return false;\"  class=\"normalefiguren chessPiece chessPiece\" src=\"images/w_king.png\" />\r\n\r\n</div>" },
        { ChessPieceType.None, ""},
    };

    public static string FromID = "";
    public static string ToID = "";
    public bool isFirstClick = true;

    private DotNetObjectReference<Chessboard> dotNetReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ChessGame.StartGame();
            ChessGame.UpdateGameState();
            ChessGame.ResetBoard();
            ChessGame.StartGame();
            // See warning about memory above in the article
            dotNetReference = DotNetObjectReference.Create(this);
            await JsRuntime.InvokeVoidAsync("setDotNetReference", dotNetReference);
        }
        if (Reload)
        {
            Reload = false;
            StateHasChanged();
        }
    }

    public ChessMatch CreateChessMatch(GameMode mode)
    {
        ChessMatch newMatch = constructor.CreateMatch(new Player("Someone", PlayerStorage.Create16DigitString()), mode);
        return newMatch;
    }

    void SetButtonState(int buttonNumber)
    {
       if (SelectedButton != buttonNumber)
       {
           SelectedButton = buttonNumber;
       }
       else
       {
           SelectedButton = 0;
       }
    }

    [JSInvokable("IdHandler")]
    public async Task IdHandler(string id, string Event)
    {
        if (Event == "mousedown")
            FromID = id;
        else if (Event == "mouseup")
        {
            ToID = id;
            if (ChessGame.MovePiece(FromID, ToID))
            {
                ChessGame.EndTurn();
                Reload = true;
                StateHasChanged();
            }
            else
            {
                ToID = FromID;
                Reload = true;
                StateHasChanged();
                //await JsRuntime.InvokeVoidAsync("MovePiece", FromID, ToID);
            }
        }
    }
}